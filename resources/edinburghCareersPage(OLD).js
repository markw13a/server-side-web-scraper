var request = require("request");
var cheerio = require("cheerio");
var querystring = require("querystring");
var Cookie = require('request-cookies');
var async  = require('async');
var Site = require("./Site");

let cookieJar = new Cookie.CookieJar();

//Post to:
//https://mycareerhub.ed.ac.uk/providers/saml/ssoredirect/1?returnURL=%2f
//Uses Three cookies

function loginEASE(callback){
	let form = {
		'login': 's1760196',
		'password': 'Edinburgh2079136',
		'submit' : 'Login now'
	};
	let formData = querystring.stringify(form); 
	request.get({
		url: 'https://www.ease.ed.ac.uk/cosign.cgi',
		jar: cookieJar
	}, function(err, res, html){
			request.post({
				url: 'https://www.ease.ed.ac.uk/cosign.cgi',
				headers: {
					'Content-Type' : 'application/x-www-form-urlencoded'
				},
				body: formData,
				jar: cookieJar,
				followAllRedirects: true,
				}, function(err, response, html){
					let loginCookie = new Cookie.Cookie(res.headers["set-cookie"][0]);
					cookieJar.add(loginCookie, 'https://www.ease.ed.ac.uk/');
					//Add all cookies received during redirection chain
					response.request.headers.cookie.split("; ").forEach(function(ele){
						cookieJar.add(new Cookie.Cookie(ele), 'https://www.ease.ed.ac.uk/');
					});
					callback(null);
				}
		);
	});
};

function authenticate(callback){
	request.get({
		url: 'https://mycareerhub.ed.ac.uk/students/login?ReturnUrl=%2f',
		jar: cookieJar
	}, function(err, res, html){
		cookieJar.add(new Cookie.Cookie(res.headers["set-cookie"][0]), 'https://mycareerhub.ed.ac.uk/');
		callback(null);
	});
};

function retrievePage(callback){
	request.get({
		url: 'https://mycareerhub.ed.ac.uk/students/login?ReturnUrl=%2f',
		jar: cookieJar,
		followAllRedirects: true
		}, 
		function(err, res, html){
			cookieJar.add(new Cookie.Cookie(res.headers["set-cookie"][0]), 'https://mycareerhub.ed.ac.uk/');
			console.log(res.headers);
			//console.log(cookieJar);
			let form = {
				"RelayState" : "ewAiAGMAbwBuAGYAaQBnAEkAZAAiADoAMQAsACIAcgBlAHQAdQByAG4AVQBSAEwAIgA6ACIALwAiACwAIgByAG8AbABlAEkAZAAiADoAbgB1AGwAbAB9AA==",
				"SAMLResponse" : "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHNhbWwycDpSZXNwb25zZSBEZXN0aW5hdGlvbj0iaHR0cHM6Ly9teWNhcmVlcmh1Yi5lZC5hYy51ay9wcm92aWRlcnMvc2FtbC9zc28iIElEPSJfZWI2MDAzYmVlMjBhMTY3OTYxZjE2NzFhODUxYjAwMDkiIEluUmVzcG9uc2VUbz0iVzc4M2FhMDU4LWUxZjYtNGRhZC04NWU5LTBmYzE5OWQwMGUzZSIgSXNzdWVJbnN0YW50PSIyMDE4LTAyLTE0VDE2OjIzOjQzLjgyMVoiIFZlcnNpb249IjIuMCIgeG1sbnM6c2FtbDJwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiPjxzYW1sMjpJc3N1ZXIgeG1sbnM6c2FtbDI9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPmh0dHBzOi8vaWRwLmVkLmFjLnVrL3NoaWJib2xldGg8L3NhbWwyOklzc3Vlcj48ZHM6U2lnbmF0dXJlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj4KPGRzOlNpZ25lZEluZm8+CjxkczpDYW5vbmljYWxpemF0aW9uTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8+CjxkczpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNyc2Etc2hhMjU2Ii8+CjxkczpSZWZlcmVuY2UgVVJJPSIjX2ViNjAwM2JlZTIwYTE2Nzk2MWYxNjcxYTg1MWIwMDA5Ij4KPGRzOlRyYW5zZm9ybXM+CjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIvPgo8ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8+CjwvZHM6VHJhbnNmb3Jtcz4KPGRzOkRpZ2VzdE1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZW5jI3NoYTI1NiIvPgo8ZHM6RGlnZXN0VmFsdWU+MXErcCtLNUUzRENiamxIcisrZlFOTHZpMDNmOUdjNTc1ZmNmaExjUWdxdz08L2RzOkRpZ2VzdFZhbHVlPgo8L2RzOlJlZmVyZW5jZT4KPC9kczpTaWduZWRJbmZvPgo8ZHM6U2lnbmF0dXJlVmFsdWU+CkY3cHgramNQMVJzQ1R1Vm0xZnBjRnFWQTZaOU1Ja1N1NnkrdTVndm9Nc08xaVpUQTVRaFJnYmlJZnZndHpFbWpHQndoNDNpZW9WNUoKYzlONFBHOXYxQkVCSjZCRytWWXdieG92eDBFc1J2dXJCRjA2QzRwUnVEdEVXcmd2SjFyc2kyK1dLZzhlM3RuVmJ0dUk3WGtKbno5eApqWWY0OXk4Y3d2Q1h5b0FqUEtNQW53bzhrV0lHalJuMGZTemI0MWtkNnZHMFYrUllMSUtyWWp6NWxJRzlqOThoTkpJcFdmSHZGWWNTCk8rYVJDZXlQVkJqWjJ4WHlmZG9Cb2Y0WlIvZ25XTithQWZkejMzQThPb1VyQVI1WkgrcHNiRStqSXRrV09reHhxeDFHcnpFeDRSdzAKN1o0dDRmclcyVXNYamxkZlh4YUZWTTg2aXN3ZEF1SnRVeWlRamc9PQo8L2RzOlNpZ25hdHVyZVZhbHVlPgo8ZHM6S2V5SW5mbz48ZHM6WDUwOURhdGE+PGRzOlg1MDlDZXJ0aWZpY2F0ZT5NSUlER3pDQ0FnT2dBd0lCQWdJVWFOekxlcURnQ3B2cVoreGRudHBqNFVyeUw5QXdEUVlKS29aSWh2Y05BUUVGQlFBd0Z6RVZNQk1HCkExVUVBeE1NYVdSd0xtVmtMbUZqTG5Wck1CNFhEVEV3TURZeU16RTBNVEl6TkZvWERUTXdNRFl5TXpFME1USXpORm93RnpFVk1CTUcKQTFVRUF4TU1hV1J3TG1Wa0xtRmpMblZyTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUE4UlhRV29NZgpyeS9yUndmWFZDeG5SZGtTMDV6SWZIZXJ3MC9jT2JTRk9PUks4ek9TaGsxUUt1ditUZXZTWkZKZ0QraXU5NkExczU1cTZrMFp0YnBXCjFpS3pUQWJITFhpa3QweVRHWWc1dGgyR3AzUHFCRmR6Q2hzZTFTZGs4ZXhSb3UxMHlPR1phcUN5Zkc2MXUrQlJnZEV6ZWZkRzZ0bzcKUHBHNEJOV0Qxbmp0TzZ6RGwvenpzWDlEaVYzS2M3RnVvNlA3YWsrWFBIR3h6dFhWTndEUlNvS1pZaU01SzExZHBHdkduaHloTDJnYgpJTzk4QXpHTUVMZGt1clRmNEVZWHVFTEdQWTgzNk5OZHpoQkVaME1vK2c5RVVxdlBROGluRk9UNFRsb1NFVXR4VXpMcjUzMFlQT2V6Cm01NVFDRGpIN0pJUzRyYytHNHJOMUI3YjF6VHlid0lEQVFBQm8xOHdYVEE4QmdOVkhSRUVOVEF6Z2d4cFpIQXVaV1F1WVdNdWRXdUcKSTJoMGRIQnpPaTh2YVdSd0xtVmtMbUZqTG5WckwybGtjQzl6YUdsaVltOXNaWFJvTUIwR0ExVWREZ1FXQkJRbUhaT2N0MmJ6YTB2MAo3cVQvZDFBVGdGWXJhakFOQmdrcWhraUc5dzBCQVFVRkFBT0NBUUVBRWdPT1h5dXROSVdObFdvRGozVktma1pGRHB3LzJxdnJQMDlFCmFZR0JDd1orTkFtUEhXdE4rM2psRHhmbllCd2hUQWFDV2xaQnFmaGs0Sk9iVkgyUTN4dTA4eldFSEJxbzRmci9ZR1lZV0FHcG5aMjkKZXBZR09KQVlidUpjV3d3TUo0b25GSHl5Z1JnbWVjNHhQbno1M25vQjhoNlZFTW1mUDc3eTBKelpJRjg2KzFpY3ZUeUpnNHlka2g4aQpQaXI0V3daenVQN3dqK2NQYjN1eU5UR1N1c3hoZ2hWb1JFa0dJRzJZQndncDNjeXZ6cXJ6aEtFa3NMc3JyeHM0bXRIS0RVRFBTUzFpCkFyQTRPSkhGb0lxRUJNZzhVT1FGWTRGQS9GVjRCRGQ2TDVaL3UwekgyQjlaMFVlR1JnNWl2UVlTT1E5SExYMkllRENRV2hjSkMzM2kKYlE9PTwvZHM6WDUwOUNlcnRpZmljYXRlPjwvZHM6WDUwOURhdGE+PC9kczpLZXlJbmZvPjwvZHM6U2lnbmF0dXJlPjxzYW1sMnA6U3RhdHVzPjxzYW1sMnA6U3RhdHVzQ29kZSBWYWx1ZT0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnN0YXR1czpTdWNjZXNzIi8+PC9zYW1sMnA6U3RhdHVzPjxzYW1sMjpFbmNyeXB0ZWRBc3NlcnRpb24geG1sbnM6c2FtbDI9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjx4ZW5jOkVuY3J5cHRlZERhdGEgSWQ9Il8yNWIyNDdlZmY1NmJkZWQ4YjYwOWY3YWNlZTVhOWE3NSIgVHlwZT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjRWxlbWVudCIgeG1sbnM6eGVuYz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjIj48eGVuYzpFbmNyeXB0aW9uTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjYWVzMTI4LWNiYyIgeG1sbnM6eGVuYz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjIi8+PGRzOktleUluZm8geG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPjx4ZW5jOkVuY3J5cHRlZEtleSBJZD0iX2RlYjVkZmI5OWQxMjU3M2YxNWI4OTNkMGJlMTFkY2NmIiBSZWNpcGllbnQ9Imh0dHBzOi8vbXljYXJlZXJodWIuZWQuYWMudWsvIiB4bWxuczp4ZW5jPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyMiPjx4ZW5jOkVuY3J5cHRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyNyc2Etb2FlcC1tZ2YxcCIgeG1sbnM6eGVuYz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjIj48ZHM6RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnI3NoYTEiIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIi8+PC94ZW5jOkVuY3J5cHRpb25NZXRob2Q+PGRzOktleUluZm8+PGRzOktleU5hbWU+Y2FyZWVyaHViLmVuY3J5cHRpb248L2RzOktleU5hbWU+PGRzOktleVZhbHVlPjxkczpSU0FLZXlWYWx1ZT48ZHM6TW9kdWx1cz42REwxQ1VwSkdGRWlEU2VmdnZQYkNmYXNJNVlYWHh6MFBWSkNUNjY3OVlqb25GNE9HbXZpT3lzSXpYSjBhaXY2Vy9UOHBkWjJzQlRTOXlQL3ZrRG4vaEZTbm0wOGY2Q0IxRTl3M3cvNlIySEhVSmprR3VZRWhYbE9vMlZUUitBMENwM05oSGdwMlZ4b3JKL29MeHA4WS9peVhjOENrYnNGdGRDeVRSZjRCZE09PC9kczpNb2R1bHVzPjxkczpFeHBvbmVudD5BUUFCPC9kczpFeHBvbmVudD48L2RzOlJTQUtleVZhbHVlPjwvZHM6S2V5VmFsdWU+PGRzMTE6REVSRW5jb2RlZEtleVZhbHVlIHhtbG5zOmRzMTE9Imh0dHA6Ly93d3cudzMub3JnLzIwMDkveG1sZHNpZzExIyI+TUlHZk1BMEdDU3FHU0liM0RRRUJBUVVBQTRHTkFEQ0JpUUtCZ1FEb012VUpTa2tZVVNJTko1Kys4OXNKOXF3amxoZGZIUFE5VWtKUApycnYxaU9pY1hnNGFhK0k3S3dqTmNuUnFLL3BiOVB5bDFuYXdGTkwzSS8rK1FPZitFVktlYlR4L29JSFVUM0RmRC9wSFljZFFtT1FhCjVnU0ZlVTZqWlZOSDREUUtuYzJFZUNuWlhHaXNuK2d2R254aitMSmR6d0tSdXdXMTBMSk5GL2dGMHdJREFRQUI8L2RzMTE6REVSRW5jb2RlZEtleVZhbHVlPjwvZHM6S2V5SW5mbz48eGVuYzpDaXBoZXJEYXRhIHhtbG5zOnhlbmM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZW5jIyI+PHhlbmM6Q2lwaGVyVmFsdWU+enlSQ1lLQUlqV1lTTitLL2Y3V0VubHhGZTkvd3R3QWs4WHVsS3pKeDlhWUVGZlNaTVdDVzU1RThuSk80NjlDaVZQd2FmVndrTmo0egpJR2NtcHJkazh1d2tkME5LTVdNOWo3UkR5dGxaZHNlZ1RPa3ZXQlRZUUZqQjkrWVd5eXRkVjZocWtxZDN2b1NSRklCMjltbEtKNDNqCk5QTDkxSVJoa1hEN3BuMTRpY1E9PC94ZW5jOkNpcGhlclZhbHVlPjwveGVuYzpDaXBoZXJEYXRhPjwveGVuYzpFbmNyeXB0ZWRLZXk+PC9kczpLZXlJbmZvPjx4ZW5jOkNpcGhlckRhdGEgeG1sbnM6eGVuYz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjIj48eGVuYzpDaXBoZXJWYWx1ZT5SUUNaVGMzR05SWmJrSW9JNnEwTStQczUrLytMYm5QRVJQVnBuK0FYWTVJQkhDemtiSjhkeS82WHlIR2VzVVFsOHEzNnJhdzJhRUp0ClM2VS9Tdld3MXd4aW5CWUhpdVlyMU1yZW1ackVENDNxei9ZOVdoRFhNeHpzaEd3bk1NcmF0eHdMYkx6NmJBN0FWV21xTVREbHdGNmwKY09LSWlsUm8vMWZiTFRyR0YxeTRITEJaalFSMHozejVYd1M2TkhmTWduc296aE8zVFVDRTI4VEpHQ3poMEZUaU8xTTlKRjFSQjk2awpjTE8vM1dYeURNUWNpamswdkFnY2dPKytGK0xuTjNrNXJIN2F2WXlCNldmemhLd2RFQ2crL3I0cXpkclhjOFhobGk1bk9SdG5RZW8yCmhBRm5td0ZpMlhWZkdmM1pzVGszV2kyRU9oL2ZlQVVTd2VyZDZxVC9mZnQyRHQ3YjdMbzBIcHo1dmpQNDhMbDdBV1l1NDF5WmczRnoKRkhuS25TSE56eGQreUFsd2UrdXhVM1hvcnFaNit5UkVnV014ZXNtenFQS3lRYkQzR2hXNXAzK1A5Z1BRVE4zdm12OWxnbXJEcXRiWgp4NDBJcGZyUCtiOXB5T0k3VGx3N2N6REdLV0dNZmdYa0ZheW9jK3Rkb3VsMnpOeXlLdmdLOUxQZkNtTC82L0RHMExBZEF6b1BCMHRuCkttcEtrWnBoUk5DeWMvVVFuengvczJuU1lvRmxsNGFaWEw0WGQ2NEYrWHlpcGpYV1VGeHorRVQvd0FCMG45clZyUG4zQ2JqN1k2Y1oKaFBwRUFrOE1pdFIwbjd2S2FFb3daWnlVV0ZBMUgzOVJxbU96b2VWYkM0bXErVkdIdWdGYm5zRXNpaXFDTHB4bVdsU1R5Z2dTVkRiago1dXZZcWVyVXppdlJic0JUbk45K29kZFgwYnFMRHFXR0Q1bDRNRkc3V0k0RzJnVUxscGlQQmhLZm56bzJkaFN1blZhODVBeWVWWnMxCkFVTnhrRWJPYUJXRFplMUxpZXgwWlVna3FzSzBzekVlN0dMKzdrbzFSK1RYVnhuMW1UYit1Qis3SmtSK25LTFpHeXUrczlzL0FnUEsKRURqY1hGU3pyMUc2OWczSjliWm9YTkhvYlpISm91NXJCcWY2UFZNa2VtY0hsMXdaTEFpdEZDVmhqUjQxMWZ3WElab3UxNGYwWVA1NQpGeUlVUzZxSzBkeCtJTlNjL1lIUFJmRDBVS0RWK2wzanR1TnFhYTR1OS9WK0dEODl1YUxla2tkbEdRS1BYREtrbGhmdDJEMXQ5RVNoCjhncmhEYmM5MlFVTjlUVXJWODRONXAvbUUxR3ZkbURoVm9LVDJZeDRPMXdEQkVvTXozTy9qZTFZRnlHZWFNTExiekxDQlZDeEN5M28KV204MDhGbkhJam9xTWRkeE5mOFdIV24zUWEzamJTSFA0OTk4UTd6Y3dNSTJJYWR0Y2VQL3RZQ09DN0cvNTV1cHJvdU1EVHExYnZpNgo0ckxiNlJTT05IRW9aWEE4N2IvdnAxK3QxMVlZUVR0SEdUdktIZEd0eW5uQ2JLMW9YV2xDcEwrMEVFU2JkMUFweFFFRFpOWHFETzNSCmg4MjYxOUpHT0JwYmFNT01BaTllNEUvZjk0MGdWWTI5VzJrK3dkNDBPWEsrTzBwT0Q5enhuZmNyY3IrTWxWMFJzSUNvRkhvNWxQMHkKRTdQbHlxdnZ3bkVNdWlnaUFoOVVaTlJqcVg5YXFERUdSR3pVaTdqYWR0R1RLQzJxWjFJSkc0N29NOGxQL1gxVnJ0RzdFSEh1UGxsaQpwbDk4dEFkUFoxUzljSFdyU0FGQ2drbHlWN1B3SFMvcFhyandkOE5USzE3WFVQSjZFVktkRk4ycjhOVHY0Vm1wZkFOZkJ3L21vSUpNCjEwTXZZOUswRStvbVBReE40bXRVR0s3MUtmZmo3UVp1RXpEdEtuNlVETHlXSDJHc1ZMUFRaRy9kd3g0bXpvU0FmL2hzM2RIUXZmWlUKTCtuclIzNitySzkxaUs4U1ZMaVNYYlBCWkJWQUhEbVpvdEFYYkdkdldhYlhsNURHdVhjYlBtbWsxdEk5OTVkd055SmJVNEk0NnJUVQpFdENlU1kraDdYL01vN3pMQnNMOGhDbEx1VVFSYVdXdzBUZU9LVlZKRDJKQ3hUZThDTDcvVGtuUHdxT29adVZ1dlVVTHc2eVpmZW52CmJidzNINGRwaVJEaXpMZzdBSWlSRW5XU3ptSlhmSnB6Y0xKNTVoMzBMTWhvSEtPN0x5RXk5Z0hZVHRhSmlpZEVNZ2RzZFU4RUREUi8KZEJXRkZSL3ZaYXlnUEYxRVNlR05MUlZnVlViK0ZMVFpCNE9pSlJiR1hZZG1aa1VOUzdNK2tuc1VkMno2OVBMakFjbmxYMWpDWWNtWApyMnpZcG5tSDNmcWEwN0ZlRm9YaVRFVVk3K3lnTmFmTkZYdms1N2kySU1na2U4VXpDb3FVTk4rK0pnQnFqTUlvTlI3ZVBaNXZjWGxNCm03Vyt0clBIdVk4WTVRczJpMGRuNEt3WGpVVmpuTUYwcVNleWtKQmxwaFNlNEh5alpVaFBSVFk4aGcxdDVmMFBqWVozS05hcHRCQ2oKVWVFYXM4NXdLWE45MWI2b3hBdzYxWFByQTBjdEJFRGx3K3d3aFJIOEUyeE1TZ09ycGRmY3FrRitRYUxzUVROb0kxRmZldjBYeWhUOAoyV1Vlb2owNmdodWlTRVF4QnpzeWtKaHlwR3pmMG9GdkVmUDhURFc5MzgvNHFpaituNjEyK0xPb0hoT1QzdjhBWXRIUUJabGE0cFJjCk9uSDV2K08yOGlSSTZoWm9aUW9RZE1lVnV4Z216TzQ2Q205d2FhSEFkV2Q2Y3VOdy9HS0h3VzUxZ0NNVDRtYTJ0eEJpcWQzdTRZY24KMjBJYU9tbjVVa2lZTC9Nc0hZWEVHelFjVFpDd0kxcjBNaHFXM1NRQXBwRW5nTDRtUWdYOWcyMVhZTXp4Vko0QURkM0hPdEVFUzA0VQoxaGZJc21ydnViZFFxeEd5RWFyUy9COTdIaGFaRU9NdXdvZjc3SXU3ajdLYXlXaG9GendNR1VZcE1RTGRrc1Q4OGdNd3RGSmo1VUp4CkF1dHVHOUlFTGhzcmIvOStVaU5SN1k0VHhkM2JuOHc1cHhnanRlWXV5MlUrVW0wTHlMdTJUZGw4d1VsOUcvRlg5eFl3STBiZCtWM2kKaTVQQTZzS1RsNHVmaUFTcjRuRE0vb290M2tmeEQ3L2ZUZ0FKWUR1Uk5Mb1JhQXVLWTdTWFIrc3gwNFFmZ1dwNVZaV1J4bUNRQmVDdgpibHNrU3p3MVBvWXlGc1NpeFFKMHJoRi9CNFZWcVljS2tTNzVlQUNlRFZGTHpyeXZ0cmRSNktTTjdqalh3K083ajlaZ0ZaWHRqM1lCCjMwSndLdWJGdHp2VGllNkpnK1BaWVRJSDd5U0FGSGgxdUFyRlYvTFAvVGdTSFRVaGZJTDV0T1JQSlNsQ3J0dU9VWVk3Uldtc1BGWVkKUVcxNDQzN1U3Zy9kaER3L2tVU0cxSTFURExGdzdtN0t0bFhOd1B3anFLMW5wcmxZVEp5K2tldE5veGR3VXVXV3VDYUc5VjR6NDFtTQo2eTNIZ2VEaDUrV0ttR3lEOWpNWkRHejFJR3MvRThDR2p3UGNHRmcrK3lzSkxJMytVWGpXWG4rbC9taVhpbHJxZjRuKzMyNFJMSXUxCmdZRTJlQkRCUWZqeWRWOS9vQXJlMmpZdlJ0cE9rb2FlVVFCL2YrUFAzL1BTa3pQQkRIbkJGVDh5WHlsS1JDR2lHSWNuOTY0dlFwYkQKWVlURll3bHhYZ0IvMVh5cUcyRDg3TjJVc2J4MGxuVGRsQlloQ3NZWXdCM2k1ZmNDM3dJUlZ2ZkpvT0VvMVpUM0pBaG5Oa0RHS3prbgpERkU2MEg4ajlmajh0M3hlSlI0ZEtRRWF0TG1UTFMzZXdmS3BrVXNCR2dqbmhZUkJGYmphMjNPTVMzSW5HcVoxME5qeGxGRGI0SXc3Ckk2eWs2cTJYclgrZUJhWS93SWE1STJMWU5IVDJSMmVMcEM3a2VIK0ZGY3ExMHg4Y0R2Y1ltNUlwVmp3emRuYWNtZE03dlJCSW5GK28KWVFYcUFDUC82dXVxMWRGTXM5ajBycWErTXcxSm9tazRYZUE3M3ZjTFBlbWhoU3ZlWFhyaGFPVWd6UFN5YUtzTkJMQzhHRVhnTDhLZwo3Vm5LR2FVY3o0L1BXc2g4Qk51bnpSSWxIc0Q2UzJOczk4V0daTTc1RGpmM0NHY2ZleTcyRGZzMDNCZi9PSHBGVm84WklGWlRJaDQ1ClNtRSt0NXZIUkg3S3V1OGFGNFc0cEliVlFMaGhhK2hDdFpOQlcyT3NORDYzQ3JvTVJXZXRIZTZoZ3YyTDlRaXFqbC82dDJaSmo0NkcKVzljZDl6VytpcjgyRGUxbVhjck80TDdqcmU5empCeTVLYTlhUkpjQ09xWWZHVTdNQjF2L0xVZjdEdzZ0SDE2MEl0TzlKdnlYVWM1MApjWitRdlZlcEhXYjB6YlBnUWdQbCtFazZEZUNQaUFwS1FaQ0hsMVo5Wjh0eWdRMEJrZHJzblJXWDgrT2tRcDlQU3dPZHpnOURuTnpWCkp3Q3BvTDk1cnRjMURxTFU2UEh2QzdheGNBYzlrQ05zS1NrZEVmUVlCSVhtTmZtZHpEbWtVd1J1azBJQUY1eGFEQ0g5RFRsZ0V3cVcKM3UxMHhqNTU0NkVLL0pQaDRudDA1UkZ0UjBxNm1kOTZwTHdIWCtpdEsyVUd2NU4ySHlIcXpBWDQ3eHZZWG1zSEZNaGFkVHhNdFAwbQpjTTdoUE51RkR2RHFxRzcvOVVnRDZ6NmNiOGJNNU5rM0dNOG5xYmxwT2Fhc0hTNUlpZUF5WnZxL2JTdmwwRjRDUkkzaU5PMmE2RHFUCk9VWUduVVVYc2RSODk0N2g2TzBydWdmaThYQXZRdmJwOENneXFTZzFicElBVEE5NkwwNVF1ZHF4dzBxc3NzWjl3L3R0YWhqNjRnRi8KNFhZK3dVNk5PaHgxb2c3R0VDZFE5d0p5MGF3bDVuUzJhUEllOVIzTUpuVU1JeWJFSWx6WURnTVBtUUc3djQ4UFFSRVcycHh6dHZzTQpHaEVzczR3Q0dyWEk1KzNXUG1oYmxteklOc2toT2prZXhpUmRVYk9IWXYyZnYzTGU2VzdBOCt2M1NpTHltZDVmSjRlZFNuY2lBNk51CnBKWFROUEZkbGRPMzV4cjVncklzMFFicEpiaVhiQk9hdFdwTFh4T3BMTHJDaDNNRzUrQWw1VWVJUTNxckRIUG1Rbkk0RmE4UW45RXIKbUdaejUvYUhiZXlyQktRZTdpUkg3dkpmSEpPSXZXb2ZWK29XSVNqaUtLVVZXUlQwZXZSNWhEd0cyT3MwZ2hvcDdyaU9pemhVQkRabwpzLzQzVldGVGl3SndqWVNSV0phVHZGTWh4VDZlQUh2UGZUamM1N2dUWmdhWjlCTmhtVGNnZEM5bGZzNXZpcXlTaVN4LzJpME5wZEw1Ck9JZWJBUUd6MFNOdjB5UExHeC93bmd6c1BaUy9MM09DOHFyT2g4ZzlNaC9XVUR2RTZKeEd6TE9USXBwU0QzejBBOFZ1WDhFd1UxYU4KZ3loTUdtTjQzT2Q4TVAxSmdNdmJoMThzcTlHWEptZ3ZpaUtPR1NRQ0IzMFBYVm5sbnFGOXBrbVMxVlNDcC9DY2hBTTBlcmd6emt3SQpMcCsvZ0RZek5QY3pudU9pdmJQZ3VTL053aStqMjNmOVNDTG45QnFuUWdOb0cvaU9WTWNMck8wbEN0bFgxK3JWTk5LVDZFWkVLY05TCjd4OVpLYmRhSnRjVU5MRFNiUFBrRVFJQVEyUUdiVitzK2o2dS92Vi82YnlRV2lSTFFDa2d2K2hBQXpoeDA3VXBXTzNnOE0xUXZNbTMKYUF3RTR3RVVoamNsYy80N0doQU5QaTF0L3VZd011VUluV3lxN2FtQWZxQ1YwdXhxUUs3MXpjbUhvYWtoQ0RZTzlzNkJwMndRQnNTTQpTNWpGYU44M0ZaM1RiT2dSSUhaWkhscDRnWE56L1luOEpYUXk5UHltSjBiRjk4OEtEQkxkZTZYVktVZytKOUVCVVhnSGpLLzBER0ZBCnN4SmJpY051MUFtdHJXZkp6RVU0Zys0b0Y3eHVmVjFzK01zQStDSUo2ekIxOE5pdGN1aVRxYmR4bEQyUmc4UVVKTXVVNHhMQ0tjeWQKVHJqUkNMTTZ0RzRlbTluakpQallBOHYwbVV5NktuSHJsaFNvWEhEN3NmNUdTL1RscklJUHlENmtlRkgvYnZkUXdwZG5JYndyb3RRLwpzVXhrNzZNY2JWREdySDdCM0drUmdkTC9VZzNRMEs4NGM0UG12VGFkcGlKT2J3ZVFSQXlwRkhGcHVjUlUvTXIzQTJPV0VkL1RRTFJ6ClQva3BWY2NOQmlxYkF0RVlHTThHZEtQbWVZSXJWNk5Uc2NJcVloQ0tLbEo3dUtWeE1pWjE1UHM3dHE1Wmo5c2tXVTltNlJlZlJLa3kKTXVIa2huOEdSWCtSckM0MlhlS1V1a2tlNXVKNTJ0QitnSjlIK240RlkwSmVWRTVSckZJbHIwK0xhOTJVY0tKdk9BbDhJcVpLbklBYQpWN1l1Yld5NnduY2JlcmMwRDBuZStsbHlrR2tjMkc0RHhiTTlSZGdkdDkwb214MmRwcTNRblR3WWFBZldPZVQySmVpeVRBQlY1cjJsCjFaTEVSc0d0QUdoMngySnFDek5oZ2llVm1FZHJqaTlVeExhb3ROOHlrOE5QVUsvZENqb3pkTGdFbERCVDNjN0c0UEJXZmxrajVPTk8KaVV4eVV1OVBPdHlsQTlGOGpGSnJUVWwzcE1lNzROTjN1Skt4VVVhc25oN2xpaVIzSlp6ZUI3amZyQnpxQXdzTElIWlVuaVpqa0t0OQpYMnF6b0VIQnZoQlVTS0dSc1BoODU3UU9HNXNyOXNYakJzUEhBa256Vyt5cVk1dDJUenYxUCttOG8wQ0JKWkFjbFdiZjd6ZXFpOHRTCnFQQ1BxSEFzYkF2ME5IeVd3VzdQMVhJRHZPd0llYnFFQmNpV3pMNHNIVEJQVHB2bFJSRWo1R0Q4blVscmlOQkNNclRucnhYOG4rVFoKZktZNjlTNDlXTmpwaGVlOVN6aFRVdFRDTTdXTHgycnFTSTEyNkpGNS9DeWxPZEN2em1VUE9WUHhncmpZSDNvalVjS3hCV25vcWNJagpLeDB0TUhSc2NQd05wbkZVTG5YOGlCN3d2eXdudzdIU1VBNStOQ1NQVCt0WnA5TFZBeXZwQkhDTTl3ZURSNzhQT1QxbVBOZEhWUkl2Ck02RFlNbVA0SE9QU2lHbW94b1hHTDFCcVJHTTlQcGN2MDUrYTZ5eE9NcUpJdWtOQ3I3eW1JVHJqdUV2bVNRcThPRFV5QmM4bURIMnQKQkZCNStIL2NHc1UyaktnMTlla1pTbkNFRmRiTVBYa0FPQitDY0EyeUZMdlRla3dwSE1tOUh1NGIxTTBwRmlCdjd4VFNmTVFMWjh5dwpyZTliQlhmMHpBaDM2SFhMYUF0OHg5a0psTFg5OTBkUHhYUVpQZ2JjM1V6OXdoRXZUTTVwTTFYa290MGdYQnBxaFpaWHhDcmZjS2ZECnZxRG1sQmZ2YU9QQnhmbEhpelNWU0ZKOEZMamlBNUhQc0xSbkxqWGN1TFNsMXVGcDRqNnlHWDZqbjFBVHVXNThEcjBCQmZaL0lqb0MKWmpKdTZqU1AybHNOQnR3U00wdmZVRVNhZFp3YXZJV1U3b1JCdXJlY1lPZjduK3oycHRoTTQ3blptUC9YWWl1TnBjVjhxVndtaHgrOQpRK2lEeWtSVWNWRUMzMjdDQmJoQVZrSHpJRGhtOGdjVThJYnNEd3hNN0xVT284RjA0bGVWYmhTZ1lFRW9BRUxWYmhUVzhuRDE1WUxDCkZCUTUvTUIya3RQczhQMm5LQWNGcEVuUjBTei9LYXNPeVI1VFNmU250c1lqazRMNWNqSGhTd0ZDZzh4MXhuTEdqbGRqZnEzNVNNaWQKQUphemw2cUhZRVBRQno3UG1UdEFySzJhSzdEaDgwYjYwbnpkMkZvRTdVZGs5TVl0ZWZMeU9OUTZGS1oyVk5pK00yTHZKU0FsRzlZcAowQUNUeDMzYkR5aHl2KzduRHl1ei9wVGtzd0VWZUl0Z21VYytYREVnVTdaUDFpN3ZYWVh6bTJwNG14VGFkR0ZZMzBOL0N1V0srSWw4CmpQdkFyaTZiODlMUm5pMnpPVzVzNVVjbjg4SmlyYWhhV1RhMGVXRHNzbkx2dmVmbWFGbkVNYU5oTFJSMDBDUWYvbWJPU0hyV3B5WGUKZisydFpXQVRIenFvVWtib2RURnpJMVhJcmQ2cURWdWlyMHVycjBYZnhlZDN0T0VsMmRScXFHRmN6ejR6WkJoTkRMNVRocVhDWU5DYgpoSksyaWRzd2hWV1FyNnBndDFFZjQycUVWdVlobkNlOENGdVZaZ2ZvVU5XaWU0VHkyNXFOMmUxUHdFZ0MvbUZPbmVIcWpIWEdydkQ4ClVjcS9wUVZ4anY4b1R4dThZRU80aDJRUDhCL01CR001WlRxUW1xeUp2NHFHVmVQbVZES0gwYytCdVZ0LzErUjZxL2ZJOWhmUzNpVVIKR2t3eGl0Y29WZDZrby9md25xN1QrOHBUSWVKSXl2eUxQQnMzRlBJZG1VaXVvcjg0RWFoN1daR088L3hlbmM6Q2lwaGVyVmFsdWU+PC94ZW5jOkNpcGhlckRhdGE+PC94ZW5jOkVuY3J5cHRlZERhdGE+PC9zYW1sMjpFbmNyeXB0ZWRBc3NlcnRpb24+PC9zYW1sMnA6UmVzcG9uc2U+",
			};
			let formData = querystring.stringify(form);
			request.post({
				url: 'https://mycareerhub.ed.ac.uk/providers/saml/ssoredirect/1?returnURL=%2f',
				headers: {
					'Host': 'mycareerhub.ed.ac.uk',
					'Connection': 'keep-alive',
					'Content-Length': '15493',
					'Cache-Control': 'max-age=0',
					'Origin': 'https://idp.ed.ac.uk',
					'Upgrade-Insecure-Requests': '1',
					'Content-Type': 'application/x-www-form-urlencoded',
					'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8',
					'Referer': 'https://idp.ed.ac.uk/idp/profile/SAML2/Redirect/SSO;jsessionid=2AC7D878844DDBF094A8F2BA67F40EB4?execution=e1s1&_eventId_proceed=1',
					'Accept-Encoding': 'gzip, deflate, br',
					'Accept-Language': 'en,en-US;q=0.9,es;q=0.8',
				},
				body: formData,
				jar: cookieJar,
			}, function(err, res, html){
				console.log(html);
				callback(null);	
			});
			
		});
};

async.series([
		loginEASE,
		//authenticate,
		retrievePage
	]);